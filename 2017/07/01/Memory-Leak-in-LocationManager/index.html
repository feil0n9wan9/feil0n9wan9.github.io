<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>LocationManager内存泄露 | 静静的扯淡</title>

  
  <meta name="author" content="Feilong Wang">
  

  
  <meta name="description" content="最近在做一个项目的内存优化时，偶然发现一个以前没有注意到的问题，LocationManager引起内存泄露，于是就想探究下泄露的Root Cause并整理出来，希望其他开发人员使用时也能够注意。">
  

  
  
  <meta name="keywords" content="Android,LocationManager,Memory Leak,Leak">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="LocationManager内存泄露">

  <meta property="og:site_name" content="静静的扯淡">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="静静的扯淡" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">静静的扯淡</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">HOME</a></li>
      
        <li><a href="/archives/">ARCHIVES</a></li>
      
        <li><a href="https://www.jianshu.com/u/5215dba27120">JIANSHU</a></li>
      
        <li><a href="https://github.com/feil0n9wan9">GITHUB</a></li>
      
        <li><a href="/about/">ABOUT</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>LocationManager内存泄露</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/07/01/Memory-Leak-in-LocationManager/" rel="bookmark">
        <time class="entry-date published" datetime="2017-07-01T12:23:04.000Z">
          2017-07-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最近在做一个项目的内存优化时，偶然发现一个以前没有注意到的问题，<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>引起内存泄露，于是就想探究下泄露的Root Cause并整理出来，希望其他开发人员使用时也能够注意。<br><a id="more"></a></p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>我们先看下面的示例代码（Android 7.0）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MainActivity.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStart();</span><br><span class="line">    registerNmeaListener();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStop();</span><br><span class="line">    unregisterNmeaListener();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerNmeaListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mOnNmeaMessageListener == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mOnNmeaMessageListener = <span class="keyword">new</span> OnNmeaMessageListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNmeaMessage</span><span class="params">(String message, <span class="keyword">long</span> timestamp)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        mLocationManager = (LocationManager) getSystemService(Context.LOCATION_SERVICE);</span><br><span class="line">        mLocationManager.addNmeaListener(mOnNmeaMessageListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unregisterNmeaListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mOnNmeaMessageListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mLocationManager.removeNmeaListener(mOnNmeaMessageListener);</span><br><span class="line">        mOnNmeaMessageListener = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是一段很常规的Android代码，我们在项目中通常都会这么实现。但如果使用<a href="https://developer.android.google.cn/studio/profile/am-hprof.html" target="_blank" rel="noopener">Memory Monitor</a>来查看堆内存，就发现会有内存泄露。</p>
<p>使用<code>Memory Monitor</code>分析步骤如下：</p>
<ol>
<li>启动应用，然后按<code>返回</code>键退出应用。</li>
<li>在<code>Android Monitor</code>的<code>Memory Monitor</code>界面点击<code>Initate GC</code>。</li>
<li>点击<code>Dump Java Heap</code>生成<code>hprof</code>文件。生成完毕<code>Android Studio</code>会自动打开。</li>
<li>选择<code>Package Tree View</code>视图，并点击<code>Class Name</code>按升序排序，这样可以迅速找到要分析的程序的包名。</li>
<li>发现<code>MainActivity</code>的实例个数为1，即没有被GC回收，发生内存泄露。</li>
</ol>
<p><img src="/images/memory-leak-in-locationmanager/app-hprof.png" alt></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>为什么会出现内存泄露？从<a href="https://developer.android.google.cn/studio/profile/am-hprof.html" target="_blank" rel="noopener">HPROF Viewer</a>的<code>Reference Tree</code>来看，<br>GC Root（Depth为0）是<code>LocationManager</code>的内部类<code>GnssStatusListenerTransport</code>成员<code>mGnssHandler</code>，<code>mGnssHandler</code>是<code>GnssStatusListenerTransport</code>的内部类<code>GnssHandler</code>的实例，所以<code>mGnssHandler</code>隐式持有外部类<code>GnssStatusListenerTransport</code>实例的引用，而<code>GnssStatusListenerTransport</code>的成员<code>mGnssNmeaListener</code>又指向了<code>MainActivity</code>的<code>OnNmeaMessageListener</code>匿名内部类实例，从而导致<code>MainActivity</code>泄露。简单概括就是：<code>mGnssHandler-&gt;GnssStatusListenerTransport-&gt;mGnssNmeaListener-&gt;MainActivity</code>。</p>
<p>我们可以来看一下<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>的源码，位于$SOURCEROOT/frameworks/base/location/java/android/location/LocationManager.java：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;OnNmeaMessageListener, GnssStatusListenerTransport&gt; mGnssNmeaListeners =</span><br><span class="line">            <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds an NMEA listener.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> listener a &#123;<span class="doctag">@link</span> OnNmeaMessageListener&#125; object to register</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if the listener was successfully added</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SecurityException if the ACCESS_FINE_LOCATION permission is not present</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiresPermission</span>(ACCESS_FINE_LOCATION)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addNmeaListener</span><span class="params">(OnNmeaMessageListener listener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addNmeaListener(listener, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds an NMEA listener.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> listener a &#123;<span class="doctag">@link</span> OnNmeaMessageListener&#125; object to register</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> handler the handler that the listener runs on.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if the listener was successfully added</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SecurityException if the ACCESS_FINE_LOCATION permission is not present</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiresPermission</span>(ACCESS_FINE_LOCATION)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addNmeaListener</span><span class="params">(OnNmeaMessageListener listener, Handler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mGpsNmeaListeners.get(listener) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// listener is already registered</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        GnssStatusListenerTransport transport =</span><br><span class="line">                <span class="keyword">new</span> GnssStatusListenerTransport(listener, handler);</span><br><span class="line">        result = mService.registerGnssStatusCallback(transport, mContext.getPackageName());</span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            mGnssNmeaListeners.put(listener, transport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Removes an NMEA listener.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> listener a &#123;<span class="doctag">@link</span> OnNmeaMessageListener&#125; object to remove</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeNmeaListener</span><span class="params">(OnNmeaMessageListener listener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        GnssStatusListenerTransport transport = mGnssNmeaListeners.remove(listener);</span><br><span class="line">        <span class="keyword">if</span> (transport != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mService.unregisterGnssStatusCallback(transport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>添加listener的时候会先判断下是否已经添加过，如果添加过了，就直接返回，如果没有，则使用传入的<a href="https://developer.android.google.cn/reference/android/location/OnNmeaMessageListener.html" target="_blank" rel="noopener">OnNmeaMessageListener</a>对象和<a href="https://developer.android.google.cn/reference/android/os/Handler.html" target="_blank" rel="noopener">Handler</a>对象构造一个对应的<code>GnssStatusListenerTransport</code>对象，并将其注册到<code>LocationManagerService</code>端，同时记录在本地<code>mGnssNmeaListeners</code>表示的HashMap中。</p>
<p>移除listener时，先将listener从本地HashMap中移除，同时将其从<code>LocationManagerService</code>注销掉。</p>
<p>注册到<code>LocationManagerService</code>和从<code>LocationManagerService</code>注销的过程与我们这里分析的问题关联不大，所以就不分析了。我们主要来看<code>GnssStatusListenerTransport</code>类。Android 7.0对<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>做了较大改动，主要是增加了对GPS以外的其他卫星定位系统的支持，统称为GNSS（Global Navigation Satellite System）。这里为了流程清晰，我们把7.0兼容之前老版本的代码删除了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This class is used to send Gnss status events to the client's specific thread.</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">GnssStatusListenerTransport</span> <span class="keyword">extends</span> <span class="title">IGnssStatusListener</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GnssStatus.Callback mGnssCallback;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OnNmeaMessageListener mGnssNmeaListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">GnssHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GnssHandler</span><span class="params">(Handler handler)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(handler != <span class="keyword">null</span> ? handler.getLooper() : Looper.myLooper());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> NMEA_RECEIVED:</span><br><span class="line">                    <span class="keyword">synchronized</span> (mNmeaBuffer) &#123;</span><br><span class="line">                        <span class="keyword">int</span> length = mNmeaBuffer.size();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">                            Nmea nmea = mNmeaBuffer.get(i);</span><br><span class="line">                            mGnssNmeaListener.onNmeaMessage(nmea.mNmea, nmea.mTimestamp);</span><br><span class="line">                        &#125;</span><br><span class="line">                        mNmeaBuffer.clear();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> GpsStatus.GPS_EVENT_STARTED:</span><br><span class="line">                    mGnssCallback.onStarted();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> GpsStatus.GPS_EVENT_STOPPED:</span><br><span class="line">                    mGnssCallback.onStopped();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> GpsStatus.GPS_EVENT_FIRST_FIX:</span><br><span class="line">                    mGnssCallback.onFirstFix(mTimeToFirstFix);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> GpsStatus.GPS_EVENT_SATELLITE_STATUS:</span><br><span class="line">                    mGnssCallback.onSatelliteStatusChanged(mGnssStatus);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mGnssHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This must not equal any of the GpsStatus event IDs</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NMEA_RECEIVED = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Nmea</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> mTimestamp;</span><br><span class="line">        String mNmea;</span><br><span class="line"></span><br><span class="line">        Nmea(<span class="keyword">long</span> timestamp, String nmea) &#123;</span><br><span class="line">            mTimestamp = timestamp;</span><br><span class="line">            mNmea = nmea;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Nmea&gt; mNmeaBuffer;</span><br><span class="line"></span><br><span class="line">    GnssStatusListenerTransport(GnssStatus.Callback callback) &#123;</span><br><span class="line">        <span class="keyword">this</span>(callback, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GnssStatusListenerTransport(GnssStatus.Callback callback, Handler handler) &#123;</span><br><span class="line">        mOldGnssCallback = <span class="keyword">null</span>;</span><br><span class="line">        mGnssCallback = callback;</span><br><span class="line">        mGnssHandler = <span class="keyword">new</span> GnssHandler(handler);</span><br><span class="line">        mOldGnssNmeaListener = <span class="keyword">null</span>;</span><br><span class="line">        mGnssNmeaListener = <span class="keyword">null</span>;</span><br><span class="line">        mNmeaBuffer = <span class="keyword">null</span>;</span><br><span class="line">        mGpsListener = <span class="keyword">null</span>;</span><br><span class="line">        mGpsNmeaListener = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    GnssStatusListenerTransport(OnNmeaMessageListener listener) &#123;</span><br><span class="line">        <span class="keyword">this</span>(listener, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GnssStatusListenerTransport(OnNmeaMessageListener listener, Handler handler) &#123;</span><br><span class="line">        mOldGnssCallback = <span class="keyword">null</span>;</span><br><span class="line">        mGnssCallback = <span class="keyword">null</span>;</span><br><span class="line">        mGnssHandler = <span class="keyword">new</span> GnssHandler(handler);</span><br><span class="line">        mOldGnssNmeaListener = <span class="keyword">null</span>;</span><br><span class="line">        mGnssNmeaListener = listener;</span><br><span class="line">        mGpsListener = <span class="keyword">null</span>;</span><br><span class="line">        mGpsNmeaListener = <span class="keyword">null</span>;</span><br><span class="line">        mNmeaBuffer = <span class="keyword">new</span> ArrayList&lt;Nmea&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onGnssStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mGpsListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Message msg = Message.obtain();</span><br><span class="line">            msg.what = GpsStatus.GPS_EVENT_STARTED;</span><br><span class="line">            mGnssHandler.sendMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onGnssStopped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mGpsListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Message msg = Message.obtain();</span><br><span class="line">            msg.what = GpsStatus.GPS_EVENT_STOPPED;</span><br><span class="line">            mGnssHandler.sendMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFirstFix</span><span class="params">(<span class="keyword">int</span> ttff)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mGpsListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTimeToFirstFix = ttff;</span><br><span class="line">            Message msg = Message.obtain();</span><br><span class="line">            msg.what = GpsStatus.GPS_EVENT_FIRST_FIX;</span><br><span class="line">            mGnssHandler.sendMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSvStatusChanged</span><span class="params">(<span class="keyword">int</span> svCount, <span class="keyword">int</span>[] prnWithFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">float</span>[] cn0s, <span class="keyword">float</span>[] elevations, <span class="keyword">float</span>[] azimuths)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mGnssCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mGnssStatus = <span class="keyword">new</span> GnssStatus(svCount, prnWithFlags, cn0s, elevations, azimuths);</span><br><span class="line"></span><br><span class="line">            Message msg = Message.obtain();</span><br><span class="line">            msg.what = GpsStatus.GPS_EVENT_SATELLITE_STATUS;</span><br><span class="line">            <span class="comment">// remove any SV status messages already in the queue</span></span><br><span class="line">            mGnssHandler.removeMessages(GpsStatus.GPS_EVENT_SATELLITE_STATUS);</span><br><span class="line">            mGnssHandler.sendMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNmeaReceived</span><span class="params">(<span class="keyword">long</span> timestamp, String nmea)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mGnssNmeaListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mNmeaBuffer) &#123;</span><br><span class="line">                mNmeaBuffer.add(<span class="keyword">new</span> Nmea(timestamp, nmea));</span><br><span class="line">            &#125;</span><br><span class="line">            Message msg = Message.obtain();</span><br><span class="line">            msg.what = NMEA_RECEIVED;</span><br><span class="line">            <span class="comment">// remove any NMEA_RECEIVED messages already in the queue</span></span><br><span class="line">            mGnssHandler.removeMessages(NMEA_RECEIVED);</span><br><span class="line">            mGnssHandler.sendMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GnssStatusListenerTransport继承自<code>IGnssStatusListener.Stub</code>，熟悉<code>Binder</code>机制的同学都知道，<code>Stub</code>类展开之后的形式是<code>Stub extends Binder(implements IBinder) implements IGnssStatusListener(implements IInterface)</code>，它是<code>Binder</code>通信的本地对象，将一个<code>Binder</code>本地对象传给另一个进程，另一个进程会拿到一个<code>Binder</code>通信的<code>Proxy</code>对象，这样另一个进程就可以通过<code>Proxy</code>对象调用本地对象的方法了，而<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>中又持有<code>LocationManagerService</code>的<code>Proxy</code>对象，这样<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>和<code>LocationManagerService</code>就可以双向通信。</p>
<p>这里<code>IGnssStatusListener</code>主要提供了5个方法供<code>LocationManagerService</code>回调以便通知相应的GNSS事件，其源码位于$SOURCEROOT/frameworks/base/location/java/android/location/IGnssStatusListener.aidl：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2008, The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">package android.location;</span><br><span class="line"></span><br><span class="line">import android.location.Location;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * &#123;@hide&#125;</span><br><span class="line"> */</span><br><span class="line">oneway interface IGnssStatusListener</span><br><span class="line">&#123;</span><br><span class="line">    void onGnssStarted();</span><br><span class="line">    void onGnssStopped();</span><br><span class="line">    void onFirstFix(int ttff);</span><br><span class="line">    void onSvStatusChanged(int svCount, in int[] svidWithFlags, in float[] cn0s,</span><br><span class="line">            in float[] elevations, in float[] azimuths);</span><br><span class="line">    void onNmeaReceived(long timestamp, String nmea);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到在<code>GnssStatusListenerTransport</code>对<code>IGnssStatusListener</code>的接口实现里，主要是将<code>LocationManagerService</code>回传的事件通过<code>mGnssHandler</code>进行异步转发。<code>mGnssHandler</code>是<code>GnssStatusListenerTransport</code>的内部类<code>GnssHandler</code>的实例，它在<code>GnssStatusListenerTransport</code>的构造函数中被创建。这里我们注意到，<code>mGnssHandler</code>的构造与外部传入的<code>Handler</code>对象有关。如果外部传入了<code>Handler</code>对象，则<code>mGnssHandler</code>绑定到外部传入的<code>Handler</code>对象所绑定的消息队列，如果外部传入的<code>Handler</code>对象为<code>null</code>，则<code>mGnssHandler</code>绑定到调用<code>addNmeaListener</code>方法所在的线程的消息队列。接下来，我们看<code>GnssHandler</code>的<a href="https://developer.android.google.cn/reference/android/os/Handler.html#handleMessage&#40;android.os.Message&#41;" target="_blank" rel="noopener">handleMessage</a>实现，这里的实现比较简单，就直接将事件通知给对应的listener。</p>
<p>看到这里，估计大家也发现了，这里的<code>mGnssHandler</code>可能会引发内存泄露，因为在调用<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html#removeNmeaListener&#40;android.location.OnNmeaMessageListener&#41;" target="_blank" rel="noopener">LocationManager.removeNmeaListener</a>时并没有任何清除与<code>mGnssHandler</code>关联的<code>Message</code>的操作。<a href="https://developer.android.google.cn/reference/android/os/Handler.html" target="_blank" rel="noopener">Handler</a>可能引起内存泄露请参考<a href="http://android-developers.blogspot.com/2009/01/avoiding-memory-leaks.html" target="_blank" rel="noopener">http://android-developers.blogspot.com/2009/01/avoiding-memory-leaks.html</a>。</p>
<p>对应到我们当前的场景，发生泄露的一个可能情况是<code>LocationManagerService</code>不断给<code>GnssStatusListenerTransport</code>对象发送信息，这些信息被<code>mGnssHandler</code>封装成<code>Message</code>投递到<code>mGnssHandler</code>绑定的消息队列里，这里就是主线程消息队列，当我们在主线程调用<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html#removeNmeaListener&#40;android.location.OnNmeaMessageListener&#41;" target="_blank" rel="noopener">LocationManager.removeNmeaListener</a>方法时，<code>mGnssHandler</code>可能已经往主线程的消息队列里投递了N多个消息。也就是说在主线程的消息队列里面，<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onDestroy&#40;&#41;" target="_blank" rel="noopener">Activity.onDestroy</a>的消息后面有很多<code>mGnssHandler</code>投递的消息。这些<code>mGnssHandler</code>投递的位于<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onDestroy&#40;&#41;" target="_blank" rel="noopener">Activity.onDestroy</a>之后的消息如果在<a href="https://developer.android.google.cn/reference/android/app/Activity.html" target="_blank" rel="noopener">Activity</a>退出时没有被清除的话，就会发生<a href="https://developer.android.google.cn/reference/android/app/Activity.html" target="_blank" rel="noopener">Activity</a>退出了，但是引用链<code>Message-&gt;mGnssHandler-&gt;GnssStatusListenerTransport-&gt;mGnssNmeaListener-&gt;MainActivity</code>还在，导致<code>MainActivity</code>泄露。</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>分析到这里就完了吗？显然不是。我们可以进一步思考：</p>
<ol>
<li><p><code>mGnssHandler</code>投递的那些可能造成内存泄露的<a href="https://developer.android.google.cn/reference/android/os/Message.html" target="_blank" rel="noopener">Message</a>也没有使用delay的方式投递，也就是说，<a href="https://developer.android.google.cn/reference/android/app/Activity.html" target="_blank" rel="noopener">Activity</a>退出过不了多久，这些<a href="https://developer.android.google.cn/reference/android/os/Message.html" target="_blank" rel="noopener">Message</a>就会被处理完，即 内存泄露一段时间后就会恢复正常，<code>MainActivity</code>又可以给被回收了。但事实确实如此吗？通过测试我们可以发现，即使过了很长时间，<code>MainActivity</code>依然回收不了。</p>
</li>
<li><p><code>Memory Monitor</code>显示GC Root是<code>mGnssHandler</code>，所以很可能不是<code>Message-&gt;mGnssHandler</code>导致泄露。Android中的GC Root主要包括如下几类，可以<a href="https://developer.android.google.cn/studio/profile/am-memory.html" target="_blank" rel="noopener">参考</a>，<code>mGssHandler</code>属于哪一类？如果有人知道，也请告诉我一下（参考2017/07/02更新）。</p>
<ul>
<li>references on the stack</li>
<li>Java Native Interface (JNI) native objects and memory</li>
<li>static variables and functions</li>
<li>threads and objects that can be referenced</li>
<li>classes loaded by the bootstrap loader</li>
<li>finalizers and unfinalized objects</li>
<li>busy monitor objects</li>
</ul>
</li>
<li><p><a href="https://developer.android.google.cn/reference/android/os/Handler.html" target="_blank" rel="noopener">Handler</a>内存泄露的问题早在2009年就被提出来了，为什么现在Android发展到了7.0，还会出现这种问题。我们查看Android源代码中<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>的提交历史，发现<code>GnssHandler</code>的机制（或者类似机制）在<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>内部已历经几个Android版本，难道就一直没人发现这个问题吗？我们在<a href="https://issuetracker.google.com" target="_blank" rel="noopener">Google Issue Tracker</a>中搜索LocationManager leak，发现确实有一些相关的<a href="https://issuetracker.google.com/issues?q=LocationManager%20leak" target="_blank" rel="noopener">issue</a>，但这些issue不知道为何最后要么不了了之，要么被Google没有任何解释就直接关闭了。</p>
</li>
<li>我们在Android的源码里搜索<a href="https://developer.android.google.cn/reference/android/os/Handler.html" target="_blank" rel="noopener">Handler</a>，看Android内置程序如何使用<a href="https://developer.android.google.cn/reference/android/os/Handler.html" target="_blank" rel="noopener">Handler</a>时会发现，在Android源码内部有些地方处理了泄露，如TV内部使用<a href="https://android.googlesource.com/platform/packages/apps/TV/+/master/common/src/com/android/tv/common/WeakHandler.java" target="_blank" rel="noopener">WeakHandler</a>，有些地方没有处理泄露，即在Android源码内部对<a href="https://developer.android.google.cn/reference/android/os/Handler.html" target="_blank" rel="noopener">Handler</a>的处理并未统一。</li>
<li><p>另外我们在<a href="https://stackoverflow.com/questions/21305233/locationlistener-and-memory-leaks" target="_blank" rel="noopener">StackOverflow</a>上发现这篇帖子，于是尝试将程序改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MainActivity</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onResume();</span><br><span class="line">      registerNmeaListener();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onPause();</span><br><span class="line">      unregisterNmeaListener();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>竟然意外的发现<strong>内存泄露消失</strong>了。但是我们知道按<code>返回</code>建退出应用时，<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onPause&#40;&#41;" target="_blank" rel="noopener">onPause</a>，<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onStop&#40;&#41;" target="_blank" rel="noopener">onStop</a>和<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onDestroy&#40;&#41;" target="_blank" rel="noopener">onDestroy</a>是在同一个<a href="https://developer.android.google.cn/reference/android/os/Message.html" target="_blank" rel="noopener">Message</a>里处理的。具体可以参见<code>ActivityThread.performDestroyActivity</code>，源码位于$SOURCEROOT/frameworks/base/core/java/android/app/ActivityThread.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ActivityClientRecord <span class="title">performDestroyActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finishing,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> getNonConfigInstance)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    Class&lt;? extends Activity&gt; activityClass = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing finish of "</span> + r);</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        activityClass = r.activity.getClass();</span><br><span class="line">        r.activity.mConfigChangeFlags |= configChanges;</span><br><span class="line">        <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">            r.activity.mFinished = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        performPauseActivityIfNeeded(r, <span class="string">"destroy"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r.stopped) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                r.activity.performStop(r.mPreserveWindow);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                            <span class="string">"Unable to stop activity "</span></span><br><span class="line">                            + safeToComponentShortString(r.intent)</span><br><span class="line">                            + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r.stopped = <span class="keyword">true</span>;</span><br><span class="line">            EventLog.writeEvent(LOG_AM_ON_STOP_CALLED, UserHandle.myUserId(),</span><br><span class="line">                    r.activity.getComponentName().getClassName(), <span class="string">"destroy"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getNonConfigInstance) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                r.lastNonConfigurationInstances</span><br><span class="line">                        = r.activity.retainNonConfigurationInstances();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                            <span class="string">"Unable to retain activity "</span></span><br><span class="line">                            + r.intent.getComponent().toShortString()</span><br><span class="line">                            + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            r.activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            mInstrumentation.callActivityOnDestroy(r.activity);</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mCalled) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                    <span class="string">"Activity "</span> + safeToComponentShortString(r.intent) +</span><br><span class="line">                    <span class="string">" did not call through to super.onDestroy()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r.window != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.window.closeAllPanels();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to destroy activity "</span> + safeToComponentShortString(r.intent)</span><br><span class="line">                        + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActivities.remove(token);</span><br><span class="line">    StrictMode.decrementExpectedActivityCount(activityClass);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然是在同一个<a href="https://developer.android.google.cn/reference/android/os/Message.html" target="_blank" rel="noopener">Message</a>里处理，那为何在<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onPause&#40;&#41;" target="_blank" rel="noopener">onPause</a>中移除listener不会造成泄露，而在<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onStop&#40;&#41;" target="_blank" rel="noopener">onStop</a>中移除listener就会造成内存泄露？</p>
</li>
</ol>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>  虽然现在我们还有很多暂时无法解答的问题，但对出现的问题我们还是有要解决方案。</p>
<h4 id="在onPause移除listener"><a href="#在onPause移除listener" class="headerlink" title="在onPause移除listener"></a>在<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onPause&#40;&#41;" target="_blank" rel="noopener">onPause</a>移除listener</h4><p>从之前分析来看，如果业务满足在<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onPause&#40;&#41;" target="_blank" rel="noopener">onPause</a>中移除listener的情况则可以使用此方法完美解决。若业务不满足在<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onPause&#40;&#41;" target="_blank" rel="noopener">onPause</a>中移除listener的情况（因为进入<a href="https://developer.android.google.cn/reference/android/app/Activity.html#onPause&#40;&#41;" target="_blank" rel="noopener">onPause</a>时Activity可能没有被完全遮挡，所以底层视图还是需要更新，因此对于这种情况，我们不能移除listener），我们只能采用work around的方式。</p>
<h4 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h4><p>可以通过反射拿到<code>mGnssHandler</code>的引用，然后移除所有相关的消息，并将<code>GnssStatusListenerTransport</code>内部<code>mGnssNmeaListener</code>的引用置<code>null</code>。</p>
<h4 id="使用SoftReference和Application-Context"><a href="#使用SoftReference和Application-Context" class="headerlink" title="使用SoftReference和Application Context"></a>使用<a href="https://developer.android.google.cn/reference/java/lang/ref/SoftReference.html" target="_blank" rel="noopener">SoftReference</a>和<a href="https://developer.android.google.cn/reference/android/app/Application.html" target="_blank" rel="noopener">Application</a> Context</h4><p>我们可以实现一个足够小的静态的<a href="https://developer.android.google.cn/reference/android/location/OnNmeaMessageListener.html" target="_blank" rel="noopener">OnNmeaMessageListener</a>内部类并持有外部<code>MainActivity</code>的软引用，然后将<a href="https://developer.android.google.cn/reference/android/location/OnNmeaMessageListener.html" target="_blank" rel="noopener">OnNmeaMessageListener</a>接收到的所有事件转发给外部的<code>MainActivity</code>来处理，以保持内部类足够小。</p>
<p>使用SoftReference的方式很好理解，但为什么要同时使用Application Context呢？这是因为GnssStatusListenerTransport无法被回收会导致LocationManager无法回收，而LocationManager持有调用getSystemService的调用者的Context。在我们这个场景中就是<code>MainActivity</code>，因此还是会导致<code>MainActivity</code>泄露。使用Application Context使得整个应用只会构造一个LocationManager，这点可以从<code>SystemServiceRegistry</code>源码来看，源码位于$SOURCEROOT/frameworks/base/core/java/android/app/SystemServiceRegistry.java：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">registerService(Context.LOCATION_SERVICE, LocationManager.class,</span><br><span class="line">        <span class="keyword">new</span> CachedServiceFetcher&lt;LocationManager&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocationManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</span><br><span class="line">        IBinder b = ServiceManager.getService(Context.LOCATION_SERVICE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LocationManager(ctx, ILocationManager.Stub.asInterface(b));</span><br><span class="line">    &#125;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们知道<a href="https://developer.android.google.cn/reference/android/content/Context.html" target="_blank" rel="noopener">Context</a>采用了设计模式里的装饰模式，<code>ContextImpl</code>是<code>ContextWrapper</code>（Activity和Application的父类）真正做事情的类，同时<code>ContextImpl</code>内部持有Out Context，即<code>ContextWrapper</code>的引用。从SystemServiceRegistry可以看出，LocationManager与<code>ContextWrapper</code>是一一对应的关系，即使用LocationManager的每一个Activity都会创建一个LocationManager的实例。在我们这个场景中LocationManager持有ContextImpl的引用，ContextImpl持有Out Context，即<code>MainActivity</code>或<code>Application</code>的引用，从而导致<code>MainActivity</code>泄露，而统一使用Application Context则不会有这个问题。</p>
<p>好了，到此我们整个LocationManager泄露的问题就说完了。对于前面还无法的解答的问题，我会继续分析。如果有人知道答案，也请告诉我一声。</p>
<h3 id="Updated-2017-07-02"><a href="#Updated-2017-07-02" class="headerlink" title="Updated 2017/07/02"></a>Updated 2017/07/02</h3><p>当我们使用上述反射机制解决了<code>MainActivity</code>的内存泄露时，<code>android.location</code>包的内存泄露还是存在的。此时我们通过<code>Memory Monitor</code>来进一步分析<code>android.location</code>包的堆内存情况，如下图：<br><img src="/images/memory-leak-in-locationmanager/location-hprof.png" alt><br>GC Root是<code>GnssStatusListenerTransport</code>，并且除了<code>FinalizerReference</code>，没有其他引用指向它。<code>FinalizerReference</code>是Android framework的一个隐藏类，主要用来实现Java的<a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-12.html#jls-12.6" target="_blank" rel="noopener">finalize机制</a>。所有重写finalize()方法的类对象，最后都会被FinalizerReference类的静态变量引用，所以当它们没有强引用时不会被虚拟机立即回收，而是GC会将这些重写了finalize()方法的对象压入到ReferenceQueue中。同时会有一个守护线程<code>Finalize Daemon</code>来真正处理调用他们的<code>finalize</code>函数，实现垃圾回收。所以重写了finalize()方法的类对象需要至少经过两轮GC才有可能被释放，具体释放时机不确定。这与我们前面介绍Android GC Root有一类是<code>finalizers and unfinalized objects</code>不谋而合。</p>
<p>但是我们在<code>GnssStatusListenerTransport</code>并没有发现<code>finalize()</code>被重写，这到底是怎么回事呢？相信大家一定也猜到了：在父类里重写了。我们依次查看<code>GnssStatusListenerTransport</code>的父类，发现<a href="https://developer.android.google.cn/reference/android/os/Binder.html" target="_blank" rel="noopener">Binder</a>类重写了<code>finalize()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        destroy();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.finalize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到此，我们终于找到了<a href="https://developer.android.google.cn/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a>泄露的Root Cause。Android系统要解决这个问题，可以在<code>GnssStatusListenerTransport</code>类中添加一个cleanup的方法来清除所有的外部引用，然后在移除listener之后调用一下cleanup方法即可。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/开发/">开发</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Android/">Android</a><a href="/tags/LocationManager/">LocationManager</a><a href="/tags/Memory-Leak/">Memory Leak</a><a href="/tags/Leak/">Leak</a>
    </span>
    

    </div>

    
  </div>
</article>

  



    </main>

    <footer class="site-footer">
  <p class="site-info">
    </br>
    
    &copy; 2020 Feilong Wang
    
    </br>
    The content of this site is licensed under
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a>.
  </p>
</footer>

    


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?45dd316ffe62b50cd95a1fd9a37e8b11";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</div>
</body>
</html>
